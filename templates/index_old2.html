<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biscuit Production Control System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .production-card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-running {
            background-color: #28a745;
        }
        .status-waiting {
            background-color: #ffc107;
        }
        .status-completed {
            background-color: #6c757d;
        }
        .monitor-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .code-display {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .sensor-btn {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">Biscuit Production Control System</h1>
        
        <!-- Production Form -->
        <div class="card production-card">
            <div class="card-header bg-primary text-white">
                <h2>Start New Production</h2>
            </div>
            <div class="card-body">
                <form id="productionForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="biscuitType" class="form-label">Biscuit Type</label>
                            <select class="form-select" id="biscuitType" required>
                                <option value="">Select type</option>
                                <option value="Chocolate">Chocolate</option>
                                <option value="Cream">Cream</option>
                                <option value="Digestive">Digestive</option>
                                <option value="GlutenFree">Gluten Free</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="brand" class="form-label">Brand</label>
                            <input type="text" class="form-control" id="brand" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Production Quantity</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productionType" id="p1" value="P1" checked>
                                <label class="form-check-label" for="p1">
                                    P1 (10 boxes)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productionType" id="p2" value="P2">
                                <label class="form-check-label" for="p2">
                                    P2 (20 boxes)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productionType" id="custom" value="Custom">
                                <label class="form-check-label" for="custom">
                                    Custom Quantity
                                </label>
                                <input type="number" class="form-control mt-2" id="customQuantity" disabled min="1">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="startBtn">Start Production</button>
                </form>
            </div>
        </div>
        
        <!-- Production Control -->
        <div class="card production-card" id="controlPanel" style="display: none;">
            <div class="card-header bg-info text-white">
                <h2>Production Control</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Current Status</h4>
                        <div id="productionStatus">
                            <p><span class="status-indicator status-waiting"></span> <span id="statusText">Waiting to start</span></p>
                            <div class="code-display" id="currentCode">No code generated yet</div>
                            <p>Boxes produced: <span id="producedCount">0</span>/<span id="totalCount">0</span></p>
                            <p>Accepted: <span id="acceptedCount">0</span></p>
                            <p>Rejected: <span id="rejectedCount">0</span></p>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-success" id="simulateConveyorBtn">Simulate Conveyor Start</button>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h4>Sensors Control</h4>
                        <div class="alert alert-warning">
                            <p>Activate these when the box is in position</p>
                            <button class="btn btn-warning sensor-btn" id="activateProximityBtn">Activate Proximity Sensor</button>
                            <button class="btn btn-warning sensor-btn" id="activateScannerBtn">Activate QR Scanner</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PLC Monitor -->
        <div class="card production-card">
            <div class="card-header bg-secondary text-white">
                <h2>PLC Memory Monitor</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h5>Conveyor Status</h5>
                        <p class="monitor-value" id="conveyorStatus">0</p>
                        <p>Address: 400001</p>
                    </div>
                    <div class="col-md-3">
                        <h5>Proximity Sensor</h5>
                        <p class="monitor-value" id="proximityStatus">0</p>
                        <p>Address: 400002</p>
                    </div>
                    <div class="col-md-3">
                        <h5>QR Scanner</h5>
                        <p class="monitor-value" id="scannerStatus">0</p>
                        <p>Address: 400003</p>
                    </div>
                    <div class="col-md-3">
                        <h5>Accepted Boxes</h5>
                        <p class="monitor-value" id="acceptedBoxes">0</p>
                        <p>Address: 400005</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Production Summary -->
        <div class="card production-card" id="summaryPanel" style="display: none;">
            <div class="card-header bg-success text-white">
                <h2>Production Summary</h2>
            </div>
            <div class="card-body" id="summaryContent">
                <!-- Summary will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM elements
        const productionForm = document.getElementById('productionForm');
        const startBtn = document.getElementById('startBtn');
        const controlPanel = document.getElementById('controlPanel');
        const summaryPanel = document.getElementById('summaryPanel');
        const statusText = document.getElementById('statusText');
        const statusIndicator = document.querySelector('#productionStatus .status-indicator');
        const currentCode = document.getElementById('currentCode');
        const producedCount = document.getElementById('producedCount');
        const totalCount = document.getElementById('totalCount');
        const acceptedCount = document.getElementById('acceptedCount');
        const rejectedCount = document.getElementById('rejectedCount');
        const simulateConveyorBtn = document.getElementById('simulateConveyorBtn');
        const activateProximityBtn = document.getElementById('activateProximityBtn');
        const activateScannerBtn = document.getElementById('activateScannerBtn');
        
        // PLC monitor elements
        const conveyorStatus = document.getElementById('conveyorStatus');
        const proximityStatus = document.getElementById('proximityStatus');
        const scannerStatus = document.getElementById('scannerStatus');
        const acceptedBoxes = document.getElementById('acceptedBoxes');
        
        // Radio button toggle
        document.querySelectorAll('input[name="productionType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('customQuantity').disabled = this.value !== 'Custom';
            });
        });
        
        // Start production
        productionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const biscuitType = document.getElementById('biscuitType').value;
            const brand = document.getElementById('brand').value;
            const productionType = document.querySelector('input[name="productionType"]:checked').value;
            const customQuantity = document.getElementById('customQuantity').value;
            
            fetch('/start_production', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    biscuit_type: biscuitType,
                    brand: brand,
                    production_type: productionType,
                    custom_quantity: customQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Show control panel
                controlPanel.style.display = 'block';
                summaryPanel.style.display = 'none';
                
                // Update initial status
                statusText.textContent = 'Production started';
                statusIndicator.className = 'status-indicator status-running';
                currentCode.textContent = data.first_code;
                totalCount.textContent = data.total_quantity;
                
                // Start monitoring
                monitorProduction();
                monitorPLC();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to start production');
            });
        });
        
        // Simulate conveyor start
        simulateConveyorBtn.addEventListener('click', function() {
            fetch('/simulate_conveyor', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                alert('Conveyor simulation started');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to simulate conveyor');
            });
        });
        
        // Activate proximity sensor
        activateProximityBtn.addEventListener('click', function() {
            fetch('/activate_proximity', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                console.log('Proximity sensor activated');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to activate proximity sensor');
            });
        });
        
        // Activate QR scanner
        activateScannerBtn.addEventListener('click', function() {
            fetch('/activate_scanner', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                console.log('QR scanner activated');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to activate QR scanner');
            });
        });
        
        // Monitor production status
        function monitorProduction() {
            fetch('/production_status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                const production = data.production_data;
                const plc = data.plc_status;
                
                // Update production status
                if (production.status === 'completed') {
                    statusText.textContent = 'Production completed';
                    statusIndicator.className = 'status-indicator status-completed';
                    showSummary(production);
                } else {
                    statusText.textContent = 'Production running';
                    statusIndicator.className = 'status-indicator status-running';
                }
                
                // Update counts
                producedCount.textContent = production.current_index;
                acceptedCount.textContent = production.accepted_boxes;
                rejectedCount.textContent = production.rejected_boxes;
                
                // Update current code if available
                if (production.current_index < production.quantity) {
                    currentCode.textContent = production.codes[production.current_index];
                }
                
                // Check box status
                checkBoxStatus();
                
                // Continue monitoring
                setTimeout(monitorProduction, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                setTimeout(monitorProduction, 5000);
            });
        }
        
        // Check box acceptance status
        function checkBoxStatus() {
            fetch('/check_box_status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                if (data.status === 'accepted') {
                    console.log('Box accepted');
                    if (data.current_code) {
                        currentCode.textContent = data.current_code;
                    }
                } else if (data.status === 'rejected') {
                    console.log('Box rejected');
                    if (data.current_code) {
                        currentCode.textContent = data.current_code;
                    }
                }
                
                if (data.completed) {
                    statusText.textContent = 'Production completed';
                    statusIndicator.className = 'status-indicator status-completed';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Monitor PLC values
        function monitorPLC() {
            fetch('/production_status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                const plc = data.plc_status;
                
                // Update PLC monitor
                conveyorStatus.textContent = plc.conveyor;
                proximityStatus.textContent = plc.proximity;
                scannerStatus.textContent = plc.scanner;
                acceptedBoxes.textContent = plc.accepted_boxes;
                
                // Continue monitoring
                setTimeout(monitorPLC, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                setTimeout(monitorPLC, 1000);
            });
        }
        
        // Show production summary
        function showSummary(production) {
            controlPanel.style.display = 'none';
            summaryPanel.style.display = 'block';
            
            const startTime = new Date(production.start_time);
            const endTime = production.end_time ? new Date(production.end_time) : new Date();
            const duration = Math.round((endTime - startTime) / 1000);
            
            const summaryHTML = `
                <h4>${production.biscuit_type} - ${production.brand}</h4>
                <p>Production type: ${production.production_type}</p>
                <p>Quantity: ${production.quantity} boxes</p>
                <p>Start time: ${startTime.toLocaleString()}</p>
                <p>End time: ${endTime.toLocaleString()}</p>
                <p>Duration: ${duration} seconds</p>
                <hr>
                <h5>Results</h5>
                <p>Accepted boxes: ${production.accepted_boxes}</p>
                <p>Rejected boxes: ${production.rejected_boxes}</p>
                <p>Success rate: ${Math.round((production.accepted_boxes / production.quantity) * 100)}%</p>
                <hr>
                <h5>Generated Codes</h5>
                <div style="max-height: 200px; overflow-y: auto;">
                    <ul>
                        ${production.codes.map(code => `<li>${code}</li>`).join('')}
                    </ul>
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = summaryHTML;
        }
    </script>
</body>
</html>