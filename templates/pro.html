<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBL Production Control System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .production-card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-waiting {
            background-color: #17a2b8;
        }
        .status-running {
            background-color: #28a745;
        }
        .status-stopped {
            background-color: #dc3545;
        }
        .status-completed {
            background-color: #6c757d;
        }
        .monitor-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .code-display {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .sensor-btn {
            margin: 5px;
        }
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
        }
        .progress-container {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">Biscuit Production Control System</h1>
        
        <!-- Production Form -->
        <div class="card production-card" id="formPanel">
            <div class="card-header bg-primary text-white">
                <h2>Start New Production</h2>
            </div>
            <div class="card-body">
                <form id="productionForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="biscuitType" class="form-label">Biscuit Type</label>
                            <select class="form-select" id="biscuitType" required>
                                <option value="">Select type</option>
                                <option value="Chocolate">Chocolate</option>
                                <option value="Cream">Cream</option>
                                <option value="Digestive">Digestive</option>
                                <option value="GlutenFree">Gluten Free</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="brand" class="form-label">Brand</label>
                            <input type="text" class="form-control" id="brand" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Production Quantity</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productionType" id="p1" value="P1" checked>
                                <label class="form-check-label" for="p1">
                                    P1 (10 boxes)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productionType" id="p2" value="P2">
                                <label class="form-check-label" for="p2">
                                    P2 (20 boxes)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="productionType" id="custom" value="Custom">
                                <label class="form-check-label" for="custom">
                                    Custom Quantity
                                </label>
                                <input type="number" class="form-control mt-2" id="customQuantity" disabled min="1">
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="startBtn">Start Production</button>
                </form>
            </div>
        </div>
        
        <!-- Production Control -->
        <div class="card production-card" id="controlPanel" style="display: none;">
            <div class="card-header bg-info text-white">
                <h2>Production Control</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Production Status</h4>
                        <div id="productionStatus">
                            <p><span class="status-indicator status-waiting"></span> <span id="statusText">Waiting to start</span></p>
                            <div class="progress-container">
                                <div class="progress">
                                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <div class="text-center mt-1">
                                    <span id="producedCount">0</span>/<span id="totalCount">0</span> boxes
                                </div>
                            </div>
                            <div class="code-display" id="currentCode">No code generated yet</div>
                            <div class="d-flex justify-content-between">
                                <div>Accepted: <span id="acceptedCount" class="badge bg-success">0</span></div>
                                <div>Rejected: <span id="rejectedCount" class="badge bg-danger">0</span></div>
                            </div>
                            <div id="timerDisplay" class="timer mt-3" style="display: none;">
                                <div class="alert alert-warning">
                                    <div class="d-flex justify-content-between">
                                        <span>Time left for sensors:</span>
                                        <span id="timeLeft">5</span>s
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3" id="conveyorControl">
                            <button class="btn btn-success" id="simulateConveyorBtn">Simulate Conveyor Start</button>
                        </div>
                        
                        <div class="mt-3" id="restartControl" style="display: none;">
                            <div class="alert alert-danger">
                                <p>Production stopped due to rejected box</p>
                                <button class="btn btn-warning" id="restartBtn">Restart Conveyor</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h4>Sensors Control</h4>
                        <div class="alert alert-warning">
                            <p>Activate these when the box is in position</p>
                            <button class="btn btn-warning sensor-btn" id="activateProximityBtn">Activate Proximity Sensor</button>
                            <button class="btn btn-warning sensor-btn" id="activateScannerBtn">Activate QR Scanner</button>
                        </div>
                        
                        <div class="mt-4">
                            <h4>PLC Memory Status</h4>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Address</th>
                                        <th>Description</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>400001</td>
                                        <td>Conveyor Control</td>
                                        <td id="conveyorStatus">0</td>
                                    </tr>
                                    <tr>
                                        <td>400002</td>
                                        <td>Proximity Sensor</td>
                                        <td id="proximityStatus">0</td>
                                    </tr>
                                    <tr>
                                        <td>400003</td>
                                        <td>QR Scanner</td>
                                        <td id="scannerStatus">0</td>
                                    </tr>
                                    <tr>
                                        <td>400005</td>
                                        <td>Accepted Boxes</td>
                                        <td id="acceptedBoxes">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Production Summary -->
        <div class="card production-card" id="summaryPanel" style="display: none;">
            <div class="card-header bg-success text-white">
                <h2>Production Summary</h2>
            </div>
            <div class="card-body" id="summaryContent">
                <!-- Summary will be loaded here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM elements
        const formPanel = document.getElementById('formPanel');
        const productionForm = document.getElementById('productionForm');
        const startBtn = document.getElementById('startBtn');
        const controlPanel = document.getElementById('controlPanel');
        const summaryPanel = document.getElementById('summaryPanel');
        const statusText = document.getElementById('statusText');
        const statusIndicator = document.querySelector('#productionStatus .status-indicator');
        const currentCode = document.getElementById('currentCode');
        const producedCount = document.getElementById('producedCount');
        const totalCount = document.getElementById('totalCount');
        const acceptedCount = document.getElementById('acceptedCount');
        const rejectedCount = document.getElementById('rejectedCount');
        const progressBar = document.getElementById('progressBar');
        const simulateConveyorBtn = document.getElementById('simulateConveyorBtn');
        const restartBtn = document.getElementById('restartBtn');
        const activateProximityBtn = document.getElementById('activateProximityBtn');
        const activateScannerBtn = document.getElementById('activateScannerBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const timeLeft = document.getElementById('timeLeft');
        const conveyorControl = document.getElementById('conveyorControl');
        const restartControl = document.getElementById('restartControl');
        
        // PLC monitor elements
        const conveyorStatus = document.getElementById('conveyorStatus');
        const proximityStatus = document.getElementById('proximityStatus');
        const scannerStatus = document.getElementById('scannerStatus');
        const acceptedBoxes = document.getElementById('acceptedBoxes');
        
        // Timer variables
        let timerInterval;
        let secondsLeft = 5;
        
        // Radio button toggle
        document.querySelectorAll('input[name="productionType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('customQuantity').disabled = this.value !== 'Custom';
            });
        });
        
        // Start production
        productionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const biscuitType = document.getElementById('biscuitType').value;
            const brand = document.getElementById('brand').value;
            const productionType = document.querySelector('input[name="productionType"]:checked').value;
            const customQuantity = document.getElementById('customQuantity').value;
            
            fetch('/start_production', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    biscuit_type: biscuitType,
                    brand: brand,
                    production_type: productionType,
                    custom_quantity: customQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Show control panel, hide form
                formPanel.style.display = 'none';
                controlPanel.style.display = 'block';
                summaryPanel.style.display = 'none';
                
                // Update initial status
                statusText.textContent = 'Waiting for conveyor to start';
                statusIndicator.className = 'status-indicator status-waiting';
                currentCode.textContent = data.first_code;
                totalCount.textContent = data.total_quantity;
                progressBar.style.width = '0%';
                
                // Show conveyor control
                conveyorControl.style.display = 'block';
                restartControl.style.display = 'none';
                timerDisplay.style.display = 'none';
                
                // Start monitoring
                monitorProduction();
                monitorPLC();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to start production');
            });
        });
        
        // Simulate conveyor start
        simulateConveyorBtn.addEventListener('click', function() {
            fetch('/simulate_conveyor_start', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                alert('Conveyor started (simulated) - Production will now begin');
                conveyorControl.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to simulate conveyor');
            });
        });
        
        // Restart conveyor after rejection
        restartBtn.addEventListener('click', function() {
            fetch('/restart_conveyor', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Update UI
                statusText.textContent = 'Waiting for conveyor to start';
                statusIndicator.className = 'status-indicator status-waiting';
                currentCode.textContent = data.current_code;
                
                // Hide restart button
                restartControl.style.display = 'none';
                timerDisplay.style.display = 'none';
                
                // Show conveyor control if needed
                conveyorControl.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to restart conveyor');
            });
        });
        
        // Activate proximity sensor
        activateProximityBtn.addEventListener('click', function() {
            fetch('/activate_proximity', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                console.log('Proximity sensor activated');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to activate proximity sensor');
            });
        });
        
        // Activate QR scanner
        activateScannerBtn.addEventListener('click', function() {
            fetch('/activate_scanner', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                console.log('QR scanner activated');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to activate QR scanner');
            });
        });
        
        // Start timer for sensor activation
        function startTimer(seconds) {
            clearInterval(timerInterval);
            secondsLeft = seconds;
            timeLeft.textContent = secondsLeft;
            timerDisplay.style.display = 'block';
            
            timerInterval = setInterval(() => {
                secondsLeft--;
                timeLeft.textContent = secondsLeft;
                
                if (secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.style.display = 'none';
                }
            }, 1000);
        }
        
        // Monitor production status
        function monitorProduction() {
            fetch('/check_production_status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                if (data.status === 'waiting_for_conveyor') {
                    statusText.textContent = 'Waiting for conveyor to start';
                    statusIndicator.className = 'status-indicator status-waiting';
                } 
                else if (data.status === 'running') {
                    statusText.textContent = 'Production running - waiting for sensors';
                    statusIndicator.className = 'status-indicator status-running';
                    
                    // Start timer if time_left is provided
                    if (data.time_left) {
                        startTimer(Math.ceil(data.time_left));
                    }
                } 
                else if (data.status === 'accepted') {
                    statusText.textContent = 'Box accepted - next box in progress';
                    statusIndicator.className = 'status-indicator status-running';
                    
                    // Update progress
                    const progress = (data.accepted_boxes + data.rejected_boxes) / parseInt(totalCount.textContent) * 100;
                    progressBar.style.width = `${progress}%`;
                    producedCount.textContent = data.accepted_boxes + data.rejected_boxes;
                    acceptedCount.textContent = data.accepted_boxes;
                    
                    // Update current code
                    if (data.current_code) {
                        currentCode.textContent = data.current_code;
                    }
                    
                    // Start timer for next box
                    startTimer(5);
                }
                else if (data.status === 'stopped') {
                    statusText.textContent = 'Production stopped - box rejected';
                    statusIndicator.className = 'status-indicator status-stopped';
                    
                    // Update rejected count
                    rejectedCount.textContent = data.rejected_boxes;
                    
                    // Show restart button
                    restartControl.style.display = 'block';
                    timerDisplay.style.display = 'none';
                } 
                else if (data.status === 'completed') {
                    statusText.textContent = 'Production completed';
                    statusIndicator.className = 'status-indicator status-completed';
                    
                    // Update final counts
                    acceptedCount.textContent = data.accepted_boxes;
                    rejectedCount.textContent = data.rejected_boxes;
                    progressBar.style.width = '100%';
                    producedCount.textContent = parseInt(totalCount.textContent);
                    
                    // Get the full production data for the summary
                    fetch('/production_summary')
                        .then(response => response.json())
                        .then(summaryData => {
                            if (summaryData.error) {
                                console.error('Error:', summaryData.error);
                                return;
                            }
                            showSummary(summaryData);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                }
                
                // Continue monitoring
                setTimeout(monitorProduction, 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                setTimeout(monitorProduction, 5000);
            });
        }
        
        // Monitor PLC values
        function monitorPLC() {
            fetch('/production_summary')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    return;
                }
                
                const plc = data.plc_status;
                
                // Update PLC monitor
                conveyorStatus.textContent = plc.conveyor;
                proximityStatus.textContent = plc.proximity;
                scannerStatus.textContent = plc.scanner;
                acceptedBoxes.textContent = plc.accepted_boxes;
                
                // Continue monitoring
                setTimeout(monitorPLC, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                setTimeout(monitorPLC, 1000);
            });
        }
        
        // Show production summary
        function showSummary(data) {
            controlPanel.style.display = 'none';
            summaryPanel.style.display = 'block';
            formPanel.style.display = 'block';
            
            const production = data.production_data || data;
            const startTime = new Date(production.start_time);
            const endTime = production.end_time ? new Date(production.end_time) : new Date();
            const duration = Math.round((endTime - startTime) / 1000);
            const successRate = Math.round((production.accepted_boxes / production.quantity) * 100);
            
            const summaryHTML = `
                <h4>${production.biscuit_type} - ${production.brand}</h4>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>Production Details</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Type:</strong> ${production.production_type}</p>
                                <p><strong>Quantity:</strong> ${production.quantity} boxes</p>
                                <p><strong>Start Time:</strong> ${startTime.toLocaleString()}</p>
                                <p><strong>End Time:</strong> ${endTime.toLocaleString()}</p>
                                <p><strong>Duration:</strong> ${duration} seconds</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>Results</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Accepted Boxes:</span>
                                    <span class="badge bg-success">${production.accepted_boxes}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Rejected Boxes:</span>
                                    <span class="badge bg-danger">${production.rejected_boxes}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Success Rate:</span>
                                    <span class="badge bg-primary">${successRate}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Generated Codes</h5>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <ul class="list-group">
                            ${production.codes.map(code => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${code}
                                    <span class="badge ${production.accepted_boxes > production.codes.indexOf(code) ? 'bg-success' : 'bg-danger'}">
                                        ${production.accepted_boxes > production.codes.indexOf(code) ? 'Accepted' : 'Rejected'}
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
                
                <div class="mt-3 text-center">
                    <button class="btn btn-primary" onclick="window.location.reload()">Start New Production</button>
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = summaryHTML;
        }
    </script>
</body>
</html>